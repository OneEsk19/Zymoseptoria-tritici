---
title: "Data_Wrangling"
author: "Georgina Robertson"
date: "05/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Connecting the metadata to our VCF isolates

Raad in the excel sheets
```{r}
library("readxl")
packageVersion("readxl")
```
```{r}
all_isolates<- read_excel("WGS_STB_Populations.xlsx", sheet = 1)
summary_pops <- read_excel("WGS_STB_Populations.xlsx", sheet = 2)
isolate_list <- read_excel("WGS_STB_Populations.xlsx", sheet = 3)
```
### Exploring the metadata

What are the variables in all_isolates?
```{r}
colnames(all_isolates)
```
What species?
```{r}
unique(all_isolates$SPECIES)
# pull out the unknown(s) for future investigation
unknownspp <- all_isolates[all_isolates$SPECIES== "?", ]
# Can we just infer this? It's unlikely to be something other that S. tritici right?
```

I noticed there were more observations in "all isolates" compared to isolate_list: 394 vs 373
```{r}
# find the difference
diffbetweenALLandLIST <- setdiff(all_isolates$ID, isolate_list$ID)
diffbetweenALLandLIST
```
```{r}
# having a look at these
all_isolates[all_isolates$ID %in% unlist(diffbetweenALLandLIST),]
# These seem to be one particular population: 	Lockhart__2001_1
table(all_isolates$Population_name) ## THIS WILL BE USEFUL FOR THE MAP
# athere are 23 "Lockhart__2001_1" in all_isolates, 21 of which are not in "isolate_details"
all_isolates[all_isolates$Population_name =="Lockhart__2001_1", 2]
# these two are
# WAI326				
# WAI329
```
Why are these two lists different?


______________________________________________________________________________

To compare what's in the excel sheet to what ended up in the VCF after filtering, this template can be used to query the vcf file:

To extract sample ID using vcftools:
```{bash eval=FALSE, include=TRUE}
# for AUS/NZ
cd ./Data/May2020_gadi_genotyping/joint_genotype

SOURCEVCF="filename.vcf" 

vcf-query -l $SOURCEVCF > samples_after_some_filters.txt
```

```{r}
IDsfromVCF <- read.table("samples_after_some_filters.txt")
colnames(IDsfromVCF) <- "ID"
```

_____________________________________________________________________________


The millennium drought occurred from late 1996 to mid-2010 according to:
http://www.bom.gov.au/climate/updates/articles/a010-southern-rainfall-decline.html

It would be nice to add a new categorical indicating drought status for each isolate.  Which data to add this info to.... not sure yet. Probably the main one: "all isolates"

What years do we have?
```{r}
unique(all_isolates$COL_YEAR)
```
So pre-drought in our data: 1980
During drought: 2001 **
** this population clusters with pre-drought in PCA, so can be treated as pre-drought.

The intervening time between pre and post, there were NO populations of Z. tritici
Post drought: 2011, 2012, 2013, 2014, 2016, 2017, 2018

Which isolates are pre-drought?
```{r}
preDisolates <- all_isolates[all_isolates$COL_YEAR == 1980, ]
preDisolates
```
Only one: WAI320
Hopefully this wasn't filtered out
```{bash}
grep WAI320 isolates_removed_by_VCFfiltering.txt
```


Which isolates are mid-drought?
```{r}
midDisolates <- all_isolates[all_isolates$COL_YEAR == 2001, ]
midDisolates$ID
```
25 of them, including Lockhart population and one each from Turretfield and Wanilla.("WAI56" and "WAI55" respectively)

```{r}
write(midDisolates$ID, "temp.txt")
```
```{bash}
grep -f temp.txt -- isolates_removed_by_VCFfiltering.txt
```
Two of them:
WAI56
WAI55
Turretfield and Wanilla removed by filters in "AUS372.biallelic.maf0.5.miss0.9.recode.vcf"

All the other isolates are post drought:

```{r}
postDisolates <- all_isolates[all_isolates$COL_YEAR != c(1980, 2001),]
```

380 isolates. This is the largest group by far, so it shouldn't matter too much if some are removed by filtering.


_______________________________________________________________

Will see if this table should be updated, and if so with what data.
________________________________________________________________________

I want a new data data for easy plotting of number of isolates per geographical site.
What variables are available?
```{r}
colnames(all_isolates)
```
How any isolates are in each population?
```{r}
location_count <- as.data.frame(table(all_isolates$Population_name))
# the dimensions match the summary_pops" df
```
Subsetting some data into a table for map graphing
```{r}
library(dplyr)
```
```{r}
# creating subset
test <- select(all_isolates, COL_YEAR,"Specific Latitude", "Specific Longitude", Population_name, Locality)

# renaming cols
colnames(test) <- c("Year", "Latitude", "Longitude", "Population_name", "Location")

# aggregating duplicatess and getting count of isolates per pop and adding as variable
mapgraphing <- test %>% group_by(Year, Latitude, Longitude, Population_name, Location) %>% summarize((n()))

# renaming new variable
colnames(mapgraphing)[6] <- "PopSize"

# clean up
rm(test)

# writing data to file for future calls
write.csv(mapgraphing, file = "mapgraphing_table.csv")
```


