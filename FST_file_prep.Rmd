---
title: "FST_File"
author: "Georgina Robertson"
date: "09/06/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Calculating FST using VCFTools and compiling data sources

1) A special version of vcf tools needed for haploid data:
https://github.com/jydu/vcftools

List of individuals in each population in separate files:
pre_pop.txt, post_pop.txt
```{bash}
vcftools --vcf drought_pops.recode.vcf --haploid --weir-fst-pop pre.txt --weir-fst-pop post.txt --out pop1_vs_pop2
```


2) taking a look at the output
```{r}
fst_file <- read.csv("./data_sheets/pop1_vs_pop2.weir.fst", header = T, sep = "\t")
```

There are some negative vales here. These occur due to the incluson of standarrd deviation in the caluculations. They should be treated as zero, so for clarity they will be changed.
```{r}
# check that the classes are correct
str(fst_file)
# = chr, in and num

# change negative values to zero
fst_file$WEIR_AND_COCKERHAM_FST[fst_file$WEIR_AND_COCKERHAM_FST<0] <- 0
```
3) Reformatting column names
```{r}
colnames(fst_file) <- c("Scaffold", "Position", "FST")

Chrom <- sapply(strsplit(fst_file$Scaffold, "_", "_") ,"[", 3)

Chrom <- as.numeric(Chrom)

fst_file <- cbind(fst_file, Chrom)
fst_file <- fst_file[, c(1, 4,2,3)]

write.csv(fst_file, "./data_sheets/fst_file.csv")
```

4) Integrating FST data with SNP indexes

Read in the individual loci files generated by the snp matrices (which were used to produce heatmaps) and merge them into one
```{r}
# set the path and pattern of the files 
files <- list.files(path ="./Processed_SNP_matrices/", pattern = "*loci.csv", full.names = T, recursive = T)

# read them all in while also setting colnames
dflist <- lapply(files, function(i){
 df <- read.csv(i, col.names = c("SNPindex", "Scaffold", "Position"))
 return(df)
})

# rbind them all together
snpindeces <- do.call(rbind, dflist)
```

Read in the calculated fst data
```{r}
fst_file <- read.csv("./data_sheets/fst_file.csv")
fst_file <- fst_file[,-1]
```

Merge the fst output and the above table by the common values: scaffold and Loci / position
```{r}
FST_SnpIndex <- merge(snpindeces, fst_file, by=c("Position", "Scaffold"))
```

This data is a mess, so will need to sort it
```{r}
FST_SnpIndex <- FST_SnpIndex[order(FST_SnpIndex[,4], FST_SnpIndex[,1]),]
```

Make some unique rownames
```{r}
test <- paste(FST_SnpIndex$Chrom, FST_SnpIndex$Position, sep = ":")

rownames(FST_SnpIndex) <- test
head(FST_SnpIndex)
```

Save this to file!
```{r}
write.csv(FST_SnpIndex ,file="./data_sheets/FST_SNPindex.csv")
```